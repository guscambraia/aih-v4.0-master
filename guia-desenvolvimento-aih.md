# üìö Guia de Desenvolvimento - Sistema de Controle de Auditoria AIH

## üìã √çndice
1. [Vis√£o Geral do Sistema](#vis√£o-geral)
2. [Estrutura de Arquivos](#estrutura-de-arquivos)
3. [Arquitetura do Sistema](#arquitetura)
4. [Banco de Dados](#banco-de-dados)
5. [API e Rotas](#api-e-rotas)
6. [Frontend](#frontend)
7. [Como Adicionar Novas Funcionalidades](#novas-funcionalidades)
8. [Padr√µes e Conven√ß√µes](#padr√µes)
9. [Comandos √öteis](#comandos)

## üéØ Vis√£o Geral do Sistema {#vis√£o-geral}

### Prop√≥sito
Sistema web para controle e auditoria de AIH (Autoriza√ß√£o de Interna√ß√£o Hospitalar), gerenciando o fluxo entre auditoria hospitalar e auditoria do SUS.

### Tecnologias Utilizadas
- **Backend**: Node.js + Express.js
- **Banco de Dados**: SQLite
- **Frontend**: HTML5 + CSS3 + JavaScript puro
- **Autentica√ß√£o**: JWT (JSON Web Tokens)
- **Hash de Senha**: bcryptjs

### Funcionalidades Principais
- Sistema de login multiusu√°rio
- Cadastro e gest√£o de AIHs
- Controle de movimenta√ß√µes (entrada/sa√≠da)
- Gest√£o de glosas e pend√™ncias
- Relat√≥rios e an√°lises
- Exporta√ß√£o de dados (CSV, Excel, JSON)
- Backup do sistema

## üìÅ Estrutura de Arquivos {#estrutura-de-arquivos}

```
projeto-aih/
‚îÇ
‚îú‚îÄ‚îÄ üìÑ server.js              # Servidor principal e rotas da API
‚îú‚îÄ‚îÄ üìÑ database.js            # Configura√ß√£o e fun√ß√µes do banco de dados
‚îú‚îÄ‚îÄ üìÑ auth.js               # Sistema de autentica√ß√£o
‚îú‚îÄ‚îÄ üìÑ package.json          # Depend√™ncias do projeto
‚îú‚îÄ‚îÄ üìÑ update-db.js          # Script para atualizar estrutura do banco
‚îÇ
‚îú‚îÄ‚îÄ üìÅ db/                   # Pasta do banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ üìÑ aih.db           # Arquivo do banco SQLite
‚îÇ
‚îú‚îÄ‚îÄ üìÅ public/               # Arquivos est√°ticos (frontend)
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ index.html       # P√°gina HTML √∫nica (SPA)
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ style.css        # Estilos CSS
‚îÇ   ‚îî‚îÄ‚îÄ üìÑ app.js          # L√≥gica JavaScript do frontend
‚îÇ
‚îî‚îÄ‚îÄ üìÅ docs/                 # Documenta√ß√£o
    ‚îú‚îÄ‚îÄ üìÑ estrutura-db.md  # Estrutura das tabelas
    ‚îú‚îÄ‚îÄ üìÑ api-endpoints.md # Documenta√ß√£o da API
    ‚îî‚îÄ‚îÄ üìÑ fluxo-telas.md   # Fluxo de navega√ß√£o
```

## üèóÔ∏è Arquitetura do Sistema {#arquitetura}

### Backend (Node.js)

#### server.js
- **Fun√ß√£o**: Servidor Express principal
- **Responsabilidades**:
  - Configurar middlewares
  - Definir todas as rotas da API
  - Servir arquivos est√°ticos
  - Implementar l√≥gica de neg√≥cios

#### database.js
- **Fun√ß√£o**: Gerenciamento do banco de dados
- **Exports**:
  - `initDB()`: Inicializa tabelas
  - `run()`: Executa comandos INSERT/UPDATE/DELETE
  - `get()`: Busca um registro
  - `all()`: Busca m√∫ltiplos registros

#### auth.js
- **Fun√ß√£o**: Autentica√ß√£o e seguran√ßa
- **Exports**:
  - `verificarToken()`: Middleware de autentica√ß√£o
  - `login()`: Fun√ß√£o de login
  - `cadastrarUsuario()`: Criar novo usu√°rio

### Frontend (SPA - Single Page Application)

#### index.html
- Cont√©m todas as telas em divs com classe `tela`
- Apenas uma tela vis√≠vel por vez (classe `ativa`)
- IDs importantes das telas:
  - `telaLogin`
  - `telaPrincipal`
  - `telaInformarAIH`
  - `telaCadastroAIH`
  - `telaInfoAIH`
  - `telaMovimentacao`
  - `telaPendencias`
  - `telaPesquisa`
  - `telaConfiguracoes`
  - `telaRelatorios`

#### app.js
- **Estado Global**: objeto `state`
- **Fun√ß√µes Principais**:
  - `api()`: Helper para chamadas √† API
  - `mostrarTela()`: Navega√ß√£o entre telas
  - `carregarDashboard()`: Atualiza estat√≠sticas
  - Handlers de eventos para cada formul√°rio

#### style.css
- Estilos modernos com vari√°veis CSS
- Classes importantes:
  - `.tela` / `.tela.ativa`: Controle de visibilidade
  - `.stat-card`: Cards de estat√≠sticas
  - `.status-badge`: Badges de status
  - `.modal`: Sistema de modais

## üíæ Banco de Dados {#banco-de-dados}

### Tabelas Principais

#### usuarios
```sql
- id (PK)
- nome (UNIQUE)
- senha_hash
- criado_em
```

#### aihs
```sql
- id (PK)
- numero_aih (UNIQUE)
- valor_inicial
- valor_atual
- status (1-4)
- competencia
- criado_em
- usuario_cadastro_id (FK)
```

#### movimentacoes
```sql
- id (PK)
- aih_id (FK)
- tipo (entrada_sus/saida_hospital)
- data_movimentacao
- usuario_id (FK)
- valor_conta
- competencia
- prof_medicina
- prof_enfermagem
- prof_fisioterapia
- prof_bucomaxilo
- status_aih
```

#### glosas
```sql
- id (PK)
- aih_id (FK)
- linha
- tipo
- profissional
- quantidade
- ativa
- criado_em
```

#### tipos_glosa
```sql
- id (PK)
- descricao (UNIQUE)
```

#### profissionais
```sql
- id (PK)
- nome
- especialidade
```

#### logs_acesso
```sql
- id (PK)
- usuario_id (FK)
- acao
- data_hora
```

### Status da AIH
1. **Finalizada com aprova√ß√£o direta**
2. **Ativa com aprova√ß√£o indireta**
3. **Ativa em discuss√£o** (padr√£o)
4. **Finalizada ap√≥s discuss√£o**

## üåê API e Rotas {#api-e-rotas}

### Autentica√ß√£o
- `POST /api/login` - Login
- `POST /api/cadastrar` - Criar usu√°rio

### AIH
- `GET /api/dashboard` - Estat√≠sticas
- `GET /api/aih/:numero` - Buscar AIH
- `POST /api/aih` - Cadastrar AIH
- `POST /api/aih/:id/movimentacao` - Nova movimenta√ß√£o

### Glosas
- `GET /api/aih/:id/glosas` - Listar glosas
- `POST /api/aih/:id/glosas` - Adicionar glosa
- `DELETE /api/glosas/:id` - Remover glosa

### Configura√ß√µes
- `GET /api/profissionais` - Listar profissionais
- `POST /api/profissionais` - Adicionar profissional
- `DELETE /api/profissionais/:id` - Remover profissional
- `GET /api/tipos-glosa` - Listar tipos
- `POST /api/tipos-glosa` - Adicionar tipo
- `DELETE /api/tipos-glosa/:id` - Remover tipo

### Pesquisa e Exporta√ß√£o
- `POST /api/pesquisar` - Pesquisa avan√ßada
- `GET /api/export/:formato` - Exportar (csv/excel/json)
- `GET /api/backup` - Download do banco

### Relat√≥rios
- `GET /api/relatorios/:tipo` - Gerar relat√≥rio
  - Tipos: acessos, glosas-profissional, aihs-profissional, aprovacoes, tipos-glosa, analise-preditiva

## üé® Frontend {#frontend}

### Fluxo de Navega√ß√£o
```
Login ‚Üí Principal ‚Üí Informar AIH ‚Üí Cadastro/Info AIH ‚Üí Movimenta√ß√£o ‚Üí Pend√™ncias
                 ‚Üì
                 ‚Üí Pesquisar
                 ‚Üí Configura√ß√µes
                 ‚Üí Relat√≥rios
                 ‚Üí Backup/Exportar
```

### Padr√£o de Comunica√ß√£o
1. Usu√°rio interage com formul√°rio
2. JavaScript captura evento
3. Chama API via fetch
4. Atualiza interface com resposta
5. Navega para pr√≥xima tela se necess√°rio

### Estado da Aplica√ß√£o
```javascript
state = {
    token: String,        // JWT token
    usuario: Object,      // Dados do usu√°rio
    aihAtual: Object,     // AIH sendo editada
    telaAnterior: String, // Para navega√ß√£o
    glosasPendentes: Array // Glosas tempor√°rias
}
```

## üöÄ Como Adicionar Novas Funcionalidades {#novas-funcionalidades}

### 1. Adicionar Nova Tabela no Banco

**Em database.js**, na fun√ß√£o `initDB()`:
```javascript
db.run(`CREATE TABLE IF NOT EXISTS nova_tabela (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    campo1 TEXT NOT NULL,
    campo2 INTEGER DEFAULT 0
)`);
```

### 2. Criar Nova Rota na API

**Em server.js**:
```javascript
app.get('/api/nova-rota', verificarToken, async (req, res) => {
    try {
        const dados = await all('SELECT * FROM nova_tabela');
        res.json({ dados });
    } catch (err) {
        res.status(500).json({ error: err.message });
    }
});
```

### 3. Adicionar Nova Tela

**Em index.html**:
```html
<div id="telaNova" class="tela">
    <header>
        <button class="btn-voltar" onclick="voltarTelaPrincipal()">‚Üê Voltar</button>
        <h2>Nova Funcionalidade</h2>
    </header>
    <div class="container">
        <!-- Conte√∫do da tela -->
    </div>
</div>
```

### 4. Adicionar L√≥gica no Frontend

**Em app.js**:
```javascript
// Adicionar bot√£o no menu
document.getElementById('btnNovaFuncao').addEventListener('click', () => {
    mostrarTela('telaNova');
    carregarDadosNovaTela();
});

// Fun√ß√£o para carregar dados
const carregarDadosNovaTela = async () => {
    try {
        const response = await api('/nova-rota');
        // Processar e exibir dados
    } catch (err) {
        console.error('Erro:', err);
    }
};
```

### 5. Atualizar Banco Existente

Criar script de atualiza√ß√£o:
```javascript
// update-nova-funcao.js
db.run(`ALTER TABLE tabela_existente ADD COLUMN novo_campo TEXT`);
```

## üìè Padr√µes e Conven√ß√µes {#padr√µes}

### Nomenclatura
- **Tabelas**: snake_case plural (ex: `tipos_glosa`)
- **Colunas**: snake_case (ex: `numero_aih`)
- **Rotas API**: kebab-case (ex: `/api/tipos-glosa`)
- **IDs HTML**: camelCase (ex: `btnNovaFuncao`)
- **Fun√ß√µes JS**: camelCase (ex: `carregarDados`)

### Estrutura de Resposta da API
```javascript
// Sucesso
{ success: true, data: {...} }

// Erro
{ error: "Mensagem de erro" }

// Lista
{ items: [...], total: 10 }
```

### Valida√ß√µes
- Sempre validar no frontend E backend
- Usar try/catch em fun√ß√µes ass√≠ncronas
- Retornar mensagens de erro claras

### Seguran√ßa
- Todas rotas (exceto login) protegidas por token
- Senhas hasheadas com bcrypt
- Sanitizar inputs antes de salvar

## üõ†Ô∏è Comandos √öteis {#comandos}

### Desenvolvimento
```bash
# Instalar depend√™ncias
npm install

# Iniciar servidor
npm start

# Desenvolvimento com auto-reload
npm run dev

# Criar/recriar banco
node database.js
```

### Manuten√ß√£o
```bash
# Atualizar estrutura do banco
node update-db.js

# Backup manual
cp db/aih.db db/backup-$(date +%Y%m%d).db
```

### Debug
```javascript
// Ver queries SQL
db.on('trace', (sql) => console.log('SQL:', sql));

// Log de requisi√ß√µes
app.use((req, res, next) => {
    console.log(`${req.method} ${req.path}`);
    next();
});
```

## üìù Checklist para Nova Funcionalidade

- [ ] Definir requisitos claramente
- [ ] Criar/alterar tabelas necess√°rias
- [ ] Implementar rotas da API
- [ ] Testar API com Postman/Insomnia
- [ ] Criar interface HTML
- [ ] Implementar l√≥gica JavaScript
- [ ] Adicionar estilos CSS
- [ ] Testar fluxo completo
- [ ] Documentar altera√ß√µes
- [ ] Criar script de atualiza√ß√£o se necess√°rio

## üîç Dicas para IA/Desenvolvimento Futuro

1. **Sempre verifique o estado atual**: Use `state` no console para debug
2. **Teste incrementalmente**: Teste API primeiro, depois frontend
3. **Mantenha consist√™ncia**: Siga os padr√µes existentes
4. **Documente mudan√ßas**: Atualize este guia com novas funcionalidades
5. **Backup antes de grandes mudan√ßas**: `cp -r projeto-aih projeto-aih-backup`

## üìû Estrutura de Comunica√ß√£o

```
Frontend (app.js) ‚Üí API (server.js) ‚Üí Database (database.js)
                                    ‚Üì
                                  Auth (auth.js)
```

Este documento deve ser atualizado sempre que novas funcionalidades forem adicionadas ao sistema.